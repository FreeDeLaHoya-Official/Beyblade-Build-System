<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Beyblade Builder — Web</title>
<link rel="icon" href="data:," />
<style>
  :root{font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{margin:0;background:#f6f7fb;color:#111}
  .wrap{max-width:1100px;margin:18px auto;padding:16px;display:grid;gap:14px}
  header h1{margin:0;font-size:1.4rem}
  .grid{display:grid;gap:12px}
  @media(min-width:900px){ .grid{grid-template-columns:320px 1fr 360px} }
  .card{background:#fff;border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(18,20,40,0.06)}
  label{display:block;font-size:13px;margin-top:8px}
  input[type="text"], input[type="number"], select, textarea{
    width:100%;padding:8px;margin-top:6px;border:1px solid #e4e6ef;border-radius:6px;font-size:14px;
  }
  button{margin-top:10px;padding:8px 10px;border-radius:8px;border:0;background:#2b6cb0;color:#fff;cursor:pointer}
  button.ter{background:#4a5568}
  .parts-list{max-height:380px;overflow:auto;margin-top:8px}
  .part-row{display:flex;gap:8px;align-items:center;padding:8px;border-radius:8px;border:1px solid #f0f2f6;margin-bottom:8px}
  .part-row input[type="checkbox"]{transform:scale(1.1)}
  .part-meta{flex:1;font-size:13px}
  .small{font-size:12px;color:#666}
  .stats{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .stat{background:#f3f6fb;padding:8px;border-radius:8px;min-width:88px;text-align:center}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .footer-note{font-size:12px;color:#666;margin-top:6px}
  input[type="file"]{display:none}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Beyblade Builder — Web (Einfach)</h1>
      <div class="small">Teile erstellen / kombinieren → Live Balance-Anzeige → Export für Nachbau</div>
    </header>

    <div class="grid">
      <!-- Editor (links) -->
      <div class="card">
        <h3>Neues Teil anlegen</h3>
        <div>
          <label>Name<input id="p-name" type="text" placeholder="Attack Ring A"></label>
          <label>Gewicht (g)<input id="p-weight" type="number" step="0.1" value="10"></label>
          <label>Durchmesser (mm)<input id="p-dia" type="number" step="0.1" value="44"></label>
          <label>Höhe (mm)<input id="p-height" type="number" step="0.1" value="4"></label>

          <label>Attack (0-20)<input id="p-attack" type="number" value="8" min="0" max="20"></label>
          <label>Defense (0-20)<input id="p-defense" type="number" value="5" min="0" max="20"></label>
          <label>Stamina (0-20)<input id="p-stamina" type="number" value="6" min="0" max="20"></label>
          <label>Speed (0-20)<input id="p-speed" type="number" value="6" min="0" max="20"></label>

          <div class="controls">
            <button id="add-part">Teil hinzufügen</button>
            <button id="save-local" class="ter">In Browser speichern</button>
            <button id="clear-local" class="ter">Löschen</button>
          </div>

          <div style="margin-top:8px">
            <label class="small">Import/Export Teile</label>
            <div class="actions">
              <button id="export-json">Export JSON</button>
              <button id="export-csv">Export CSV</button>
              <label for="import-file" style="background:#eee;color:#222;padding:7px;border-radius:6px;cursor:pointer">Import JSON</label>
              <input id="import-file" type="file" accept=".json">
            </div>
            <div class="footer-note">Die gespeicherten Teile bleiben im Browser (localStorage) erhalten.</div>
          </div>
        </div>
      </div>

      <!-- Parts & selection (mitte) -->
      <div class="card">
        <h3>Teile / Dein Beyblade</h3>
        <div class="parts-list" id="parts-list"></div>

        <h4 style="margin-top:12px">Ausgewählte Teile</h4>
        <div id="selected-names" class="small"></div>

        <div class="stats" id="stat-box">
          <div class="stat"><div class="small">Attack</div><div id="s-attack">0</div></div>
          <div class="stat"><div class="small">Defense</div><div id="s-defense">0</div></div>
          <div class="stat"><div class="small">Stamina</div><div id="s-stamina">0</div></div>
          <div class="stat"><div class="small">Speed</div><div id="s-speed">0</div></div>
          <div class="stat"><div class="small">Gewicht</div><div id="s-weight">0 g</div></div>
          <div class="stat"><div class="small">Balance Score</div><div id="s-balance">0</div></div>
        </div>

        <div style="margin-top:10px">
          <button id="export-measurements">Teileliste (CSV) herunterladen</button>
        </div>

      </div>

      <!-- Visualization (rechts) -->
      <div class="card">
        <h3>Visualisierung</h3>
        <canvas id="radar" width="300" height="300"></canvas>
        <div style="margin-top:10px" id="advice" class="small"></div>
      </div>
    </div>

    <footer class="small">Hinweis: Das ist ein Planungs-/Export-Tool. Für 3D-Modelle/ STL / Fertigung: CAD (Fusion360 / FreeCAD) verwenden.</footer>
  </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script>
(() => {
  // --- simple data model & storage ---
  const STORAGE_KEY = 'bey_parts_v1';
  let parts = [];
  let selectedIds = new Set();

  // default example parts
  const defaultParts = [
    {id: genId(), name:'Attack Ring - Dragon', weight:9.0, dia:44.0, height:5.0, attack:9, defense:3, stamina:4, speed:8},
    {id: genId(), name:'Weight Disk - Heavy10', weight:15.0, dia:44.0, height:3.5, attack:2, defense:8, stamina:9, speed:2},
    {id: genId(), name:'Blade Base - Flat', weight:4.0, dia:43.0, height:3.0, attack:4, defense:5, stamina:7, speed:7},
  ];

  function genId(){ return 'p'+Math.random().toString(36).slice(2,9); }

  function saveParts(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(parts)); }
  function loadParts(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){ try{ parts = JSON.parse(raw); return; }catch(e){} }
    parts = defaultParts.slice();
    saveParts();
  }

  // --- DOM refs ---
  const dom = {
    partsList: document.getElementById('parts-list'),
    addBtn: document.getElementById('add-part'),
    exportJson: document.getElementById('export-json'),
    exportCsv: document.getElementById('export-csv'),
    importFile: document.getElementById('import-file'),
    saveLocal: document.getElementById('save-local'),
    clearLocal: document.getElementById('clear-local'),
    exportMeasurements: document.getElementById('export-measurements'),
    selectedNames: document.getElementById('selected-names'),
    sAttack: document.getElementById('s-attack'),
    sDefense: document.getElementById('s-defense'),
    sStamina: document.getElementById('s-stamina'),
    sSpeed: document.getElementById('s-speed'),
    sWeight: document.getElementById('s-weight'),
    sBalance: document.getElementById('s-balance'),
    advice: document.getElementById('advice'),
    inputs: {
      name: document.getElementById('p-name'),
      weight: document.getElementById('p-weight'),
      dia: document.getElementById('p-dia'),
      height: document.getElementById('p-height'),
      attack: document.getElementById('p-attack'),
      defense: document.getElementById('p-defense'),
      stamina: document.getElementById('p-stamina'),
      speed: document.getElementById('p-speed'),
    }
  };

  // --- Chart.js radar ---
  const ctx = document.getElementById('radar').getContext('2d');
  const chart = new Chart(ctx, {
    type:'radar',
    data: {
      labels: ['Attack','Defense','Stamina','Speed'],
      datasets: [{ label:'Stats', data:[0,0,0,0], fill:true, backgroundColor:'rgba(51,102,204,0.25)', borderColor:'rgb(51,102,204)' }]
    },
    options: {
      scales: {
        r: { suggestedMin:0, suggestedMax:30 }
      }
    }
  });

  // --- UI functions ---
  function renderParts(){
    dom.partsList.innerHTML = '';
    parts.forEach(p => {
      const row = document.createElement('div'); row.className='part-row';
      const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = selectedIds.has(p.id);
      cb.addEventListener('change', ()=> {
        if(cb.checked) selectedIds.add(p.id); else selectedIds.delete(p.id);
        updateSelected();
        saveParts();
      });
      const meta = document.createElement('div'); meta.className='part-meta';
      meta.innerHTML = `<strong>${escapeHtml(p.name)}</strong><div class="small">w:${p.weight}g • Ø:${p.dia}mm • h:${p.height}mm</div>
        <div class="small">atk:${p.attack} def:${p.defense} sta:${p.stamina} spd:${p.speed}</div>`;

      const btnDel = document.createElement('button'); btnDel.textContent='Löschen'; btnDel.className='ter';
      btnDel.addEventListener('click', ()=> { parts = parts.filter(x => x.id !== p.id); selectedIds.delete(p.id); renderParts(); saveParts(); updateSelected(); });

      const btnEdit = document.createElement('button'); btnEdit.textContent='Bearbeiten';
      btnEdit.addEventListener('click', ()=> {
        // fill editor with values for quick edit
        dom.inputs.name.value = p.name;
        dom.inputs.weight.value = p.weight;
        dom.inputs.dia.value = p.dia;
        dom.inputs.height.value = p.height;
        dom.inputs.attack.value = p.attack;
        dom.inputs.defense.value = p.defense;
        dom.inputs.stamina.value = p.stamina;
        dom.inputs.speed.value = p.speed;
        // delete old part (will re-add when user clicks add)
        parts = parts.filter(x => x.id !== p.id); selectedIds.delete(p.id);
        renderParts(); saveParts(); updateSelected();
      });

      row.appendChild(cb); row.appendChild(meta); row.appendChild(btnEdit); row.appendChild(btnDel);
      dom.partsList.appendChild(row);
    });
  }

  function updateSelected(){
    const sel = parts.filter(p => selectedIds.has(p.id));
    dom.selectedNames.textContent = sel.map(s => s.name).join(' • ') || '(keine Teile ausgewählt)';
    const sums = sel.reduce((acc,p)=> {
      acc.attack += Number(p.attack||0);
      acc.defense += Number(p.defense||0);
      acc.stamina += Number(p.stamina||0);
      acc.speed += Number(p.speed||0);
      acc.weight += Number(p.weight||0);
      return acc;
    }, {attack:0,defense:0,stamina:0,speed:0,weight:0});

    // Balance score: relative difference to mean
    const arr = [sums.attack, sums.defense, sums.stamina, sums.speed];
    const mean = (arr.reduce((a,b)=>a+b,0))/4;
    let imbalance = 0;
    if(mean>0) imbalance = arr.reduce((acc,v)=> acc + Math.abs(v-mean)/mean, 0)/4;
    const balanceScore = Math.max(0, Math.round((1 - imbalance) * 100));

    dom.sAttack.textContent = sums.attack;
    dom.sDefense.textContent = sums.defense;
    dom.sStamina.textContent = sums.stamina;
    dom.sSpeed.textContent = sums.speed;
    dom.sWeight.textContent = sums.weight.toFixed(1) + ' g';
    dom.sBalance.textContent = balanceScore + ' / 100';

    // update chart
    chart.data.datasets[0].data = [sums.attack,sums.defense,sums.stamina,sums.speed];
    chart.update();

    // advice
    dom.advice.innerHTML = generateAdvice(arr, balanceScore, sums.weight);
  }

  function generateAdvice(arr, score, totalWeight){
    if(arr.every(v=>v===0)) return 'Wähle Teile aus, um Balance und Stats zu sehen.';
    let advice = '';
    if(score < 40) {
      const maxIndex = arr.indexOf(Math.max(...arr));
      const labels = ['Attack','Defense','Stamina','Speed'];
      advice += `Sehr unausgeglichen — Fokus liegt stark auf ${labels[maxIndex]}. `;
      advice += 'Tipp: Ergänze Teile, die die schwächeren Werte stärken.';
    } else if(score < 70) {
      advice += 'Leicht unausgeglichen. Kleine Anpassungen (Gewicht/Teile tauschen) helfen.';
    } else {
      advice += 'Gut ausbalanciert — weiter so!';
    }
    advice += ` Gesamtgewicht: ${totalWeight.toFixed(1)} g.`;
    return advice;
  }

  // --- add part ---
  dom.addBtn.addEventListener('click', ()=>{
    const p = {
      id: genId(),
      name: dom.inputs.name.value.trim() || 'Teil ' + (parts.length+1),
      weight: parseFloat(dom.inputs.weight.value) || 0,
      dia: parseFloat(dom.inputs.dia.value) || 0,
      height: parseFloat(dom.inputs.height.value) || 0,
      attack: parseFloat(dom.inputs.attack.value) || 0,
      defense: parseFloat(dom.inputs.defense.value) || 0,
      stamina: parseFloat(dom.inputs.stamina.value) || 0,
      speed: parseFloat(dom.inputs.speed.value) || 0,
    };
    parts.push(p);
    // select it by default
    selectedIds.add(p.id);
    renderParts(); updateSelected(); saveParts();
    // clear name field quickly
    dom.inputs.name.value = '';
  });

  // --- export / import ---
  dom.exportJson.addEventListener('click', ()=> {
    downloadFile('bey_parts.json', JSON.stringify(parts, null, 2), 'application/json');
  });
  dom.exportCsv.addEventListener('click', ()=> {
    const csv = toCsv(parts);
    downloadFile('bey_parts.csv', csv, 'text/csv');
  });
  dom.importFile.addEventListener('change', (e)=> {
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const imported = JSON.parse(reader.result);
        if(Array.isArray(imported)){
          // add ids if missing
          imported.forEach(x=>{ if(!x.id) x.id = genId(); });
          parts = imported;
          selectedIds = new Set();
          renderParts(); updateSelected(); saveParts();
          alert('Import erfolgreich');
        } else alert('Ungültiges Format (erwarte Array)');
      }catch(err){ alert('Fehler beim Einlesen: '+err.message) }
    };
    reader.readAsText(f);
    e.target.value = '';
  });

  dom.exportMeasurements.addEventListener('click', ()=> {
    const sel = parts.filter(p => selectedIds.has(p.id));
    if(sel.length === 0){ alert('Bitte mindestens ein Teil auswählen'); return; }
    const csv = toCsv(sel, ['name','weight','dia','height','attack','defense','stamina','speed']);
    downloadFile('beyblade_measurements.csv', csv, 'text/csv');
  });

  dom.saveLocal.addEventListener('click', ()=> { saveParts(); alert('Im Browser gespeichert'); });
  dom.clearLocal.addEventListener('click', ()=> { if(confirm('Alles löschen?')){ localStorage.removeItem(STORAGE_KEY); loadParts(); selectedIds = new Set(); renderParts(); updateSelected(); } });

  function toCsv(arr, fields){
    if(!fields) fields = ['id','name','weight','dia','height','attack','defense','stamina','speed'];
    const esc = v => String(v).replaceAll('"','""');
    const rows = [fields.join(',')];
    arr.forEach(o => {
      rows.push(fields.map(f=>`"${esc(o[f] ?? '')}"`).join(','));
    });
    return rows.join('\\n');
  }

  function downloadFile(filename, content, mime){
    const a = document.createElement('a');
    const blob = new Blob([content], {type:mime});
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 60000);
  }

  function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;'); }

  // --- init ---
  loadParts();
  renderParts();
  updateSelected();

})();
</script>
</body>
</html>
